# TÃªn cá»§a quy trÃ¬nh (workflow)
name: Deploy Frontend CI/CD to GitHub Pages

# KÃ­ch hoáº¡t quy trÃ¬nh khi cÃ³ sá»± kiá»‡n
on:
  # Cháº¡y khi cÃ³ push code lÃªn nhÃ¡nh 'main'
  push:
    branches: ["main"]
  # Cháº¡y thá»§ cÃ´ng (Manual trigger)
  workflow_dispatch:

# Äá»‹nh nghÄ©a cÃ¡c cÃ´ng viá»‡c (jobs)
jobs:
  # ğŸ¯ Job 1: CI (Continuous Integration) - Build vÃ  Test
  build:
    # TÃªn hiá»ƒn thá»‹ trong GitHub Actions UI
    name: Build & Test Project
    # Runner sáº½ cháº¡y trÃªn mÃ¡y áº£o Ubuntu má»›i nháº¥t
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        # Action chuáº©n Ä‘á»ƒ táº£i mÃ£ nguá»“n vá» Runner
        uses: actions/checkout@v4

      - name: Setup Node.js Environment
        # Action chuáº©n Ä‘á»ƒ cÃ i Ä‘áº·t Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # PhiÃªn báº£n Node.js báº¡n muá»‘n dÃ¹ng

      - name: Install Dependencies
        # Runner cháº¡y lá»‡nh cÃ i Ä‘áº·t thÆ° viá»‡n
        run: npm install

      - name: Run Tests (CI Check)
        # Runner cháº¡y lá»‡nh kiá»ƒm thá»­ (vÃ­ dá»¥: linting, unit tests)
        # BÆ¯á»šC NÃ€Y Sáº¼ Dá»ªNG WORKFLOW Náº¾U CÃ“ Lá»–I TEST
        run: npm run test --if-present

      - name: Build Production Files
        # Runner cháº¡y lá»‡nh build (táº¡o ra thÆ° má»¥c tÄ©nh)
        run: npm run build

      - name: Get Build Folder Path
        # TÃ¬m thÆ° má»¥c build thá»±c táº¿ (dist, build, out,...)
        # Thay 'build/' báº±ng thÆ° má»¥c output cá»§a dá»± Ã¡n báº¡n
        id: get_build_path
        run: echo "BUILD_PATH=$(find . -maxdepth 1 -type d -name 'build' -print -quit || find . -maxdepth 1 -type d -name 'dist' -print -quit)" >> $GITHUB_OUTPUT
        
      # ğŸ“¦ LÆ°u sáº£n pháº©m Ä‘Ã£ build (Artifact) Ä‘á»ƒ Job sau sá»­ dá»¥ng
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-artifact
          path: ${{ steps.get_build_path.outputs.BUILD_PATH }} # Sá»­ dá»¥ng Ä‘Æ°á»ng dáº«n thÆ° má»¥c build tÃ¬m Ä‘Æ°á»£c
          retention-days: 1 # LÆ°u Artifact trong 1 ngÃ y

  # ğŸš€ Job 2: CD (Continuous Deployment) - Triá»ƒn khai lÃªn GitHub Pages
  deploy:
    # Chá»‰ cháº¡y khi Job 'build' thÃ nh cÃ´ng
    needs: build
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    
    # Cho phÃ©p GitHub Pages sá»­ dá»¥ng permissions
    permissions:
      contents: write # Cáº§n quyá»n ghi Ä‘á»ƒ Ä‘áº©y code lÃªn nhÃ¡nh 'gh-pages'
      pages: write   # Cáº§n quyá»n Ä‘á»ƒ cáº­p nháº­t cáº¥u hÃ¬nh Pages
      id-token: write # Cáº§n quyá»n Ä‘á»ƒ chá»©ng thá»±c

    steps:
      - name: Download Build Artifact
        # Táº£i láº¡i gÃ³i sáº£n pháº©m Ä‘Ã£ Ä‘Æ°á»£c build tá»« Job trÆ°á»›c
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-artifact
          path: ./temp-deploy # Táº£i vá» thÆ° má»¥c táº¡m

      # Cáº¥u hÃ¬nh GitHub Pages
      - name: Configure Pages
        uses: actions/configure-pages@v5

      # Triá»ƒn khai sá»­ dá»¥ng action cá»§a GitHub
      - name: Upload artifact to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./temp-deploy/build # Äáº£m báº£o Ä‘Æ°á»ng dáº«n chÃ­nh xÃ¡c Ä‘áº¿n thÆ° má»¥c build bÃªn trong thÆ° má»¥c táº£i xuá»‘ng

      # HoÃ n táº¥t viá»‡c triá»ƒn khai
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4